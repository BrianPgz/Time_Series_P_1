---
title: "Beer"
author: "Brian Perez G"
date: "14/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r echo=FALSE}
library(forecast)
library(timeSeries)
library(nortest)
library(tseries)
library(TSA)
library(lmtest)
library(ggplot2)

```



```{r echo=TRUE}
Data_beer= read.csv(file = "monthly_beer.csv")
```

```{r echo=TRUE}
head(Data_beer)
```

Tenemos $Data_beer$ en data frame tenemos que tener el formato de serie de tiempo. 

Vamos a obtener la primera y la última fecha.

```{r echo=TRUE}
tamanio_base = length(Data_beer$Month)
tamanio_base
```

Tenemos que la base tiene 476 datos. 

```{r echo=TRUE}
Data_beer$Month[1]
Data_beer$Month[476]
```

La base tiene fecha de inicio en enero de 1956 y fin en agosto de 1995. Vamos a crear el objeto serie de tiempo.

```{r echo=TRUE}
S_beer = ts(Data_beer$Monthly.beer.production, start = c(1956, 1), end = c(1995, 8), frequency = 12)
head(S_beer,24)
```

Vamos a visualizar la serie de tiempo. 

```{r echo=TRUE}
ts.plot(S_beer,main = "Serie de tiempo de producción mensual de cerveza")
```

Obtengamos algunas medidas importantes. 

```{r echo=TRUE}
mean(S_beer)
var(S_beer)
sd(S_beer)
```

Tenemos que mensualmente en promedio de produce $136.3954$ millones de litros de cerveza con una desviación estándar de $33.73872$ millones de litros de cerveza al mes. 


Veamos los correlogramas de la serie de tiempo. 

```{r echo=TRUE}
tsdisplay(S_beer, main = "Serie de tiempo de producción mensual de cerveza")
```

Observamos varianza creciente, al principio se ve puede observar tendencia pero cerca de 1980 se rompe la tendencia, o bien, la tendencia cambia. 

En el $ACF$ Observamos alta correlación y que además no decae la correlación de manera exponencial. Para el $PACF$ observamos que la correlación parcial sigue siendo alta y por ello aproximadamente 15 barras se salen de las barras de confianza.  


Podemos observar ciclos con un periodo igual a 12. 

```{r echo=TRUE}
desc_datos = decompose(S_beer)
plot(desc_datos)   

```

Observamos que la tendencia cambia y tenemos ciclos, además del componente aleatorio. Vamos a hacer pruebas, y si es el caso haremos transformaciones para arreglar la serie.   

Haciendo el $bp \ test$ vamos a contrastar la varianza. 

$Ho:$ La varianza es constante (Homocedasticidad)   $vs.$  $H1:$ La varianza no es constate (Heterocedasticidad)

```{r echo=TRUE}
t1=seq(1956,1995.59,by=1/12)
bptest( S_beer ~ t1)  
```

Con un $p-value$ de casi cero entonces rechazamos $Ho$, entonces tenemos varianza no constante. 

Vamos a hacer la prueba de Dickey-Fuller

$Ho:$ La serie no es estacionaria $vs.$ $H1:$ La serie es estacionaria


```{r echo=TRUE}
adf.test(S_beer) 
```

Con un $p-value = 0.01$, y un nivel de confianza del $.05$, rechazamos hipótesis nula, entonces es estacionaria. 


Para contrastar nuestros resultados vamos a usar la prueba de phillips. 

$Ho:$ La serie es estacionaria $vs.$ $H1:$ La serie no es estacionaria

```{r echo=TRUE}
kpss.test(S_beer)
```
Con un $p-value=0.01$ rechazamos $Ho$ entonces la serie no es estacionaria. Como esto contradice a la prueba anterior debemos de trabajar con una trandformación de la serie.

Para el periodo vamos a usar la función $cycle()$

```{r echo=TRUE}
plot(cycle(S_beer),main="Ciclos") 
```

Como la serie va de 1956 a 1995, en la gráfica observamos 10 ciclos cada 10 años, entonces el ciclo se repite anualmente, con un periodo $d=12$ en meses. 


Veamos primero qué pasa con el logaritmo de la serie. 


```{r echo=TRUE}
log_S_beer = log(S_beer)
ts.plot(log_S_beer, main= "logaritmo de la serie")

```

Parece ser que la varianza se estabiliza pero seguimos teniendo problemas con la tendencia. 

```{r echo=TRUE}
bptest(log_S_beer~ t1)

```

Con un $p-value = 0.3914$ la varianza es constante. 


```{r echo=TRUE}
adf.test(log_S_beer) 
```

Con un $p-value=0.03871$ menor al $.05$, rechazamos $Ho$ entonces la serie es estacionaria. Para contrastar, tenemos que hacer la prueba de phillips. 

$Ho:$ La serie es estacionaria $vs.$ $H1:$ La serie no es estacionaria

```{r echo=TRUE}
kpss.test(log_S_beer)
```
Para la transformación logaritmo se siguen contradiciendo las pruebas. Aunque tenemos varianza constante. 



```{r echo=TRUE}
desc_datos = decompose(log_S_beer)
plot(desc_datos)  
```

Con el logaritmo obtenemos varianza constante, seguimos viendo ciclos anuales aunque seguimos teniendo problemas con la tendencia. 


Queremos usar métodos de descomposición adecuado. Primero veamos modelos de regresión. 


```{r echo=TRUE}
time=t1
time2=t1*t1
time3=t1*t1*t1
regresion_simple= lm(log_S_beer ~ time)
plot(log_S_beer,main="Serie con varianza constante (Logaritmo)",lwd = 3, xlab = "Tiempo", col = "black")
lines(time,regresion_simple$fitted.values,col="blue",lwd = 3)
```

Parece ser que un modelo lineal no es la mejor opción, usemos un polinomio. 

```{r echo=TRUE}
time=t1
time2=t1*t1
time3=t1*t1*t1
regresion_square= lm(log_S_beer ~ time + time2)
plot(log_S_beer,main="Serie con varianza constante (Logaritmo)",lwd = 3, xlab = "Tiempo", col = "black")
lines(time,regresion_square$fitted.values,col="blue",lwd = 3)
```

Parece que un polinomio cuadratico ajusta bien a la serie de tiempo. 

Vamos a predecir tres años futuros, primero vamos a llenar los datos que se van a predecir con NA.


```{r echo=TRUE}
time_plus=seq(1956,1998.59,by=1/12)
time_plus2=time_plus*time_plus
time_plus3=time_plus*time_plus*time_plus
df_pred <- data.frame(X = time_plus,Y=time_plus2 , Z = c(log_S_beer, rep(NA, 36) ))
```

```{r echo=TRUE}

predictions <- lm(formula = Z ~ X + Y, data = df_pred)
predictor=predict(object = predictions, newdata = df_pred) 
plot_serie=plot(log_S_beer,main="Serie con varianza constante (Logaritmo y Prediccion de 3 años)",lwd = 3, xlab = "Tiempo", col = "black",xlim=c(1956,1999))
lines(time_plus,predictor,col="blue",lwd = 3)

```

Haciendo la predicción con el polinomio de grado dos observamos el cambio de la tendencia cerca del año 1980.


Veamos qué pasa cuando aplicamos una diferencia a los datos bajo la transformación logaritmo. 

```{r echo=TRUE}
diff_S_berr = diff(log_S_beer)
plot(diff_S_berr)   

```

Con este método quitamos la tendencia, se observan ciclos pero tenemos varianza constante, procedemos a hacer las pruebas. 


```{r echo=TRUE}
new_t= t1[2:(length(t1))]
bptest(diff_S_berr ~ new_t)
```
Rechazamos




```{r echo=TRUE}
diff_2_S_berr = diff(diff(S_beer))
plot(diff_2_S_berr)   

```
```{r echo=TRUE}
diff_3_S_berr = diff(diff(diff(S_beer)))
plot(diff_3_S_berr)   

```
Observamos que no ganamos varianza constante haciendo diferencias pero quitamos la tendencia y ciclos. 









Tenemos que ajustar el modelo ARIMA O SARIMA. 












